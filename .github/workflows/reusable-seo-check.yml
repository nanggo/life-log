# .github/workflows/reusable-seo-check.yml
name: Reusable SEO Check

on:
  workflow_call:
    inputs:
      event_name:
        description: 'The event that triggered this workflow (pull_request, deployment_status, workflow_dispatch)'
        required: true
        type: string
      environment:
        description: 'Environment being validated (production, preview, etc.)'
        required: false
        type: string
        default: 'production'
      validate_all:
        description: 'Force validate all pages'
        required: false
        type: boolean
        default: false
    outputs:
      exit_code:
        description: 'The exit code of the SEO validation script.'
        value: ${{ jobs.check.outputs.exit_code }}

jobs:
  check:
    name: Run SEO Check and Handle Results
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.seo-validation.outputs.exit_code }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Install pnpm
        uses: pnpm/action-setup@v4.0.0
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Build Output
        uses: actions/cache@v4
        with:
          path: |
            .svelte-kit
            build
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*', 'posts/**/*', 'static/**/*', 'package.json', 'svelte.config.js', 'vite.config.js', 'tailwind.config.js') }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Build Project
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Run SEO Validation
        id: seo-validation
        run: |
          set +e

          # Ensure .seo-reports directory exists
          mkdir -p .seo-reports

          # Run SEO validation
          pnpm seo:validate
          SEO_EXIT_CODE=$?
          echo "exit_code=$SEO_EXIT_CODE" >> $GITHUB_OUTPUT

          # Create a status file for debugging
          echo "SEO validation completed with exit code: $SEO_EXIT_CODE" > .seo-reports/validation-status.txt
          echo "Timestamp: $(date)" >> .seo-reports/validation-status.txt

          exit 0

      - name: Generate SEO Summary
        if: always()
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs')
            const path = require('path')

            try {
              const reportsDir = '.seo-reports'
              let triggerInfo = ''
              
              if ('${{ inputs.event_name }}' === 'workflow_dispatch') {
                triggerInfo = `ğŸ”§ **ìˆ˜ë™ ì‹¤í–‰** - í™˜ê²½: ${{ inputs.environment }}`
                if ('${{ inputs.validate_all }}' === 'true') {
                  triggerInfo += ', ëª¨ë“  í˜ì´ì§€ ê°•ì œ ê²€ì¦'
                }
                triggerInfo += '\n\n'
              }

              if (!fs.existsSync(reportsDir) || fs.readdirSync(reportsDir).length === 0) {
                core.summary.addRaw(`${triggerInfo}âŒ SEO ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
                await core.summary.write()
                return
              }

              const files = fs
                .readdirSync(reportsDir)
                .filter((file) => file.startsWith('seo-report-') && file.endsWith('.json'))
                .map((file) => path.join(reportsDir, file))

              if (files.length === 0) {
                core.summary.addRaw(`${triggerInfo}âŒ SEO ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)
                await core.summary.write()
                return
              }

              files.sort((a, b) => fs.statSync(b).mtime - fs.statSync(a).mtime)
              const latestReport = files[0]
              const data = JSON.parse(fs.readFileSync(latestReport, 'utf8'))
              const { summary } = data

              const statusText =
                summary.totalErrors === 0
                  ? 'âœ… **SEO ê²€ì¦ í†µê³¼!**'
                  : `âŒ **SEO ê²€ì¦ ì‹¤íŒ¨** - ${summary.totalErrors}ê°œì˜ ì˜¤ë¥˜ ë°œê²¬`

              core.summary
                .addRaw(triggerInfo)
                .addHeading('ğŸ“Š SEO ê²€ì¦ ê²°ê³¼', 2)
                .addTable([
                  [
                    { data: 'í•­ëª©', header: true },
                    { data: 'ê°’', header: true }
                  ],
                  ['ì „ì²´ í˜ì´ì§€', summary.totalPages.toString()],
                  ['ìœ íš¨í•œ í˜ì´ì§€', summary.validPages.toString()],
                  ['ì´ ì˜¤ë¥˜', summary.totalErrors.toString()],
                  ['ì´ ê²½ê³ ', summary.totalWarnings.toString()],
                  ['robots.txt', summary.robotsTxtValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'],
                  ['sitemap.xml', summary.sitemapXmlValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨']
                ])
                .addHeading('ğŸ¯ ê²€ì¦ ìƒíƒœ', 3)
                .addRaw(statusText)

              await core.summary.write()
            } catch (error) {
              console.error('SEO ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)
              core.summary.addRaw('âŒ SEO ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.')
              await core.summary.write()
            }

      - name: Comment PR with SEO Results
        if: inputs.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs')
            const path = require('path')

            try {
              const reportsDir = '.seo-reports'
              if (!fs.existsSync(reportsDir)) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: 'âŒ **SEO ê²€ì¦ ì‹¤íŒ¨** - ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
                })
                return
              }

              const files = fs
                .readdirSync(reportsDir)
                .filter((file) => file.startsWith('seo-report-') && file.endsWith('.json'))
                .map((file) => path.join(reportsDir, file))

              if (files.length === 0) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: 'âŒ **SEO ê²€ì¦ ì‹¤íŒ¨** - ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
                })
                return
              }

              files.sort((a, b) => fs.statSync(b).mtime - fs.statSync(a).mtime)
              const latestReport = files[0]
              const data = JSON.parse(fs.readFileSync(latestReport, 'utf8'))
              const { summary } = data

              const statusIcon = summary.totalErrors === 0 ? 'âœ…' : 'âŒ'
              const statusText = summary.totalErrors === 0 ? 'í†µê³¼' : 'ì‹¤íŒ¨'

              let issueDetails = ''
              if (summary.totalErrors > 0 || summary.totalWarnings > 0) {
                issueDetails = '\n\n### ğŸ” ë°œê²¬ëœ ë¬¸ì œ\n'
                data.pageResults.forEach((page) => {
                  if (page.issues.length > 0) {
                    issueDetails += `\n**${page.pageName}:**\n`
                    const errors = page.issues.filter((i) => i.severity === 'error')
                    const warnings = page.issues.filter((i) => i.severity === 'warning')
                    if (errors.length > 0) {
                      issueDetails += `- âŒ ${errors.length}ê°œì˜ ì˜¤ë¥˜\n`
                    }
                    if (warnings.length > 0) {
                      issueDetails += `- âš ï¸ ${warnings.length}ê°œì˜ ê²½ê³ \n`
                    }
                  }
                })
              }

              let comment = `## ${statusIcon} SEO ê²€ì¦ ${statusText}\n\n`
              comment += '| í•­ëª© | ê°’ |\n'
              comment += '|--------|-------|\n'
              comment += `| ì „ì²´ í˜ì´ì§€ | ${summary.totalPages} |\n`
              comment += `| ìœ íš¨í•œ í˜ì´ì§€ | ${summary.validPages} |\n`
              comment += `| ì´ ì˜¤ë¥˜ | ${summary.totalErrors} |\n`
              comment += `| ì´ ê²½ê³  | ${summary.totalWarnings} |\n`
              comment += `| robots.txt | ${summary.robotsTxtValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n`
              comment += `| sitemap.xml | ${summary.sitemapXmlValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n`
              comment += `${issueDetails}\n\n`
              comment += 'ğŸ“ **ìƒì„¸ ë¦¬í¬íŠ¸**ëŠ” ì›Œí¬í”Œë¡œìš° ë¡œê·¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n'
              comment += `<sub>SEO ê²€ì¦ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë¨ - ì‹¤í–‰ #${{ github.run_number }}</sub>`

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              })
            } catch (error) {
              console.error('PR ì½”ë©˜íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âŒ **SEO ê²€ì¦ ì˜¤ë¥˜** - ê²°ê³¼ ì²˜ë¦¬ ì‹¤íŒ¨. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
              })
            }

      - name: Create Issue on SEO Failure (Post-Deployment)
        if: inputs.event_name == 'deployment_status' && steps.seo-validation.outputs.exit_code != '0'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs')
            const path = require('path')

            try {
              const reportsDir = '.seo-reports'
              if (!fs.existsSync(reportsDir)) {
                console.log('SEO ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
                return
              }

              const files = fs
                .readdirSync(reportsDir)
                .filter((file) => file.startsWith('seo-report-') && file.endsWith('.json'))
                .map((file) => path.join(reportsDir, file))

              if (files.length === 0) {
                console.log('SEO ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
                return
              }

              files.sort((a, b) => fs.statSync(b).mtime - fs.statSync(a).mtime)
              const latestReport = files[0]
              const data = JSON.parse(fs.readFileSync(latestReport, 'utf8'))
              const { summary } = data

              const environment = '${{ inputs.environment }}'
              const deploymentUrl = 'https://blog.nanggo.net'

              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'seo,post-deployment',
                per_page: 1
              })

              if (issues.length > 0) {
                const existingIssue = issues[0]
                let updateComment = `## ğŸ”„ ë°°í¬ í›„ SEO ìƒíƒœ ì—…ë°ì´íŠ¸ - ${new Date().toISOString().split('T')[0]}\n\n`
                updateComment += `**í™˜ê²½**: ${environment}\n`
                updateComment += `**ë°°í¬ URL**: ${deploymentUrl}\n\n`
                updateComment += '| í•­ëª© | ê°’ |\n'
                updateComment += '|--------|-------|\n'
                updateComment += `| ì „ì²´ í˜ì´ì§€ | ${summary.totalPages} |\n`
                updateComment += `| ìœ íš¨í•œ í˜ì´ì§€ | ${summary.validPages} |\n`
                updateComment += `| ì´ ì˜¤ë¥˜ | ${summary.totalErrors} |\n`
                updateComment += `| ì´ ê²½ê³  | ${summary.totalWarnings} |\n`
                updateComment += `| robots.txt | ${summary.robotsTxtValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n`
                updateComment += `| sitemap.xml | ${summary.sitemapXmlValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n\n`
                updateComment += `ğŸ“ **ìµœì‹  ë¦¬í¬íŠ¸**: ì›Œí¬í”Œë¡œìš° [ì—¬ê¸°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})ë¥¼ í™•ì¸í•˜ì„¸ìš”\n\n`
                updateComment += `<sub>ë°°í¬ í›„ SEO ê²€ì¦ì— ì˜í•´ ìë™ ìƒì„±ë¨</sub>`

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: updateComment
                })
                return
              }

              let issueBody = `## ğŸš¨ ë°°í¬ í›„ SEO ë¬¸ì œ ë°œê²¬\n\n`
              issueBody += `**${environment}** í™˜ê²½ ë°°í¬ í›„ SEO ê²€ì¦ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`
              issueBody += `**ë°°í¬ URL**: ${deploymentUrl}\n\n`
              issueBody += '### ğŸ“Š ìš”ì•½\n\n'
              issueBody += '| í•­ëª© | ê°’ |\n'
              issueBody += '|--------|-------|\n'
              issueBody += `| ì „ì²´ í˜ì´ì§€ | ${summary.totalPages} |\n`
              issueBody += `| ìœ íš¨í•œ í˜ì´ì§€ | ${summary.validPages} |\n`
              issueBody += `| ì´ ì˜¤ë¥˜ | **${summary.totalErrors}** |\n`
              issueBody += `| ì´ ê²½ê³  | ${summary.totalWarnings} |\n`
              issueBody += `| robots.txt | ${summary.robotsTxtValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n`
              issueBody += `| sitemap.xml | ${summary.sitemapXmlValid ? 'âœ… ìœ íš¨' : 'âŒ ë¹„ìœ íš¨'} |\n\n`
              issueBody += '### ğŸ” í˜ì´ì§€ë³„ ë¬¸ì œ\n'

              data.pageResults.forEach((page) => {
                if (page.issues.length > 0) {
                  issueBody += `\n**${page.pageName}:**\n`
                  const errors = page.issues.filter((i) => i.severity === 'error')
                  const warnings = page.issues.filter((i) => i.severity === 'warning')

                  errors.forEach((error) => {
                    issueBody += `- âŒ **${error.type.replace(/_/g, ' ').toUpperCase()}**: ${error.tag} - ${error.message}\n`
                  })

                  warnings.forEach((warning) => {
                    issueBody += `- âš ï¸ **${warning.type.replace(/_/g, ' ').toUpperCase()}**: ${warning.tag} - ${warning.message}\n`
                  })
                }
              })

              issueBody += `\n\n### ğŸ›  ì¡°ì¹˜ í•„ìš”\n\n`
              issueBody += `1. [ì›Œí¬í”Œë¡œìš°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})ì—ì„œ ìƒì„¸ SEO ë¦¬í¬íŠ¸ë¥¼ ê²€í† í•˜ì„¸ìš”\n`
              issueBody += '2. ì†ŒìŠ¤ ì½”ë“œì—ì„œ í™•ì¸ëœ SEO ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”\n'
              issueBody += '3. `pnpm seo:validate`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”\n'
              issueBody += '4. ìˆ˜ì • ì‚¬í•­ì„ ë°°í¬í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”\n\n'
              issueBody += '---\n\n'
              issueBody += `<sub>ì´ ì´ìŠˆëŠ” ${new Date().toISOString()}ì— ë°°í¬ í›„ SEO ê²€ì¦ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</sub>`

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ ë°°í¬ í›„ SEO ë¬¸ì œ - ${summary.totalErrors}ê°œì˜ ì˜¤ë¥˜ ë°œê²¬`,
                body: issueBody,
                labels: ['seo', 'post-deployment', 'bug']
              })

              console.log(`ë°°í¬ í›„ SEO ì´ìŠˆ ìƒì„±ë¨: ${issue.data.html_url}`)
            } catch (error) {
              console.error('SEO ì´ìŠˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)
            }

      - name: Close SEO Issue on Success (Post-Deployment)
        if: inputs.event_name == 'deployment_status' && steps.seo-validation.outputs.exit_code == '0'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            try {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'seo,post-deployment',
                per_page: 1
              })

              if (issues.length > 0) {
                const issue = issues[0]
                
                const commentBody = `## âœ… ë°°í¬ í›„ SEO ê²€ì¦ ì„±ê³µ!\n\n` +
                  `ëª¨ë“  SEO ê²€ì¦ì´ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì´ ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤.\n\n` +
                  `**ê²€ì¦ ì‹œê°„**: ${new Date().toISOString()}\n` +
                  `**ì›Œí¬í”Œë¡œìš°**: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}\n\n` +
                  `<sub>ë°°í¬ í›„ SEO ê²€ì¦ì— ì˜í•´ ìë™ìœ¼ë¡œ ë‹«í˜</sub>`

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                })

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                })

                console.log(`SEO ì´ìŠˆ í•´ê²°ë¨: ${issue.html_url}`)
              }
            } catch (error) {
              console.error('SEO ì´ìŠˆ ë‹«ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)
            }